name: "Test Workflow"
on:
  pull_request:
    types: [assigned, opened, synchronize, reopened]
jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      packages: write
    outputs:
      previousSummaryContent: ${{ steps.read-previous-report.outputs.previousSummaryContent }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
      - name: Install Deps
        run: npm install
      - name: Test
        run: npx vitest --coverage.enabled true
      - name: Download Previous Artifacts
        uses: actions/github-script@v6
        env:
          WORKFLOW_FILENAME: test.yml
          ARTIFACT_NAME: coverage-previous
          ARTIFACT_FILENAME: coverage-previous.zip
          UNZIP_DIR: ./coverage-previous
        with:
          script: |
            const { script } = await import('${{ github.workspace }}/scripts/download-previous-artifact.js')
            await script({github, context, core})
      - name: List Files
        run: ls -R
      - name: Read Previous Coverage Report
        id: read-previous-report
        run: |
          if [ -f "./coverage-previous/coverage-summary.json" ]; then
            echo "yes"
            previousSummaryContent=$(cat ./coverage-previous/coverage-summary.json)
            # the following lines are only required for multi line json
            previousSummaryContent="${previousSummaryContent//'%'/'%25'}"
            previousSummaryContent="${previousSummaryContent//$'\n'/'%0A'}"
            previousSummaryContent="${previousSummaryContent//$'\r'/'%0D'}"
            # end of optional handling for multi line json
            echo "::set-output name=previousSummaryContent::$previousSummaryContent"
          else 
            echo "no"
          fi
      - name: Upload Latest Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-latest
          path: coverage

  report:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    outputs:
      latestSummaryContent: ${{ steps.read-latest-report.outputs.latestSummaryContent }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download Latest Artifacts
        uses: actions/download-artifact@v4
      - name: List Files
        run: ls -R
      - name: Read Latest Coverage Report
        id: read-latest-report
        run: |
          latestSummaryContent=$(cat ./coverage-latest/coverage-summary.json)
          # the following lines are only required for multi line json
          latestSummaryContent="${latestSummaryContent//'%'/'%25'}"
          latestSummaryContent="${latestSummaryContent//$'\n'/'%0A'}"
          latestSummaryContent="${latestSummaryContent//$'\r'/'%0D'}"
          # end of optional handling for multi line json
          echo "::set-output name=latestSummaryContent::$latestSummaryContent"
      - name: Copy report
        run: mv coverage-latest coverage-previous
      - name: Upload Previous Coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-previous
          path: coverage

  comment:
    needs: [test, report]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      repository-projects: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Create PR Comment
        id: create-comment
        uses: actions/github-script@v6
        with:
          script: |
            const latestMarkdownContent = JSON.parse(JSON.stringify(${{ needs.report.outputs.latestSummaryContent }}));
            const previousMarkdownContent = JSON.parse(JSON.stringify(${{ needs.test.outputs.previousSummaryContent }}));
            console.log("yml latestMarkdownContent: ", latestMarkdownContent, previousMarkdownContent);

            const { createComment } = await import('${{ github.workspace }}/scripts/create-comment.js')
            await createComment({github, context, latestMarkdownContent, previousMarkdownContent});

